<!-- src/app/components/mensajes/chat/chat.component.html -->
<!-- Componente de Chat - Mostrando nombre del usuario mejorado -->

<div class="chat-container">
  <!-- Header del chat -->
  <div class="chat-header">
    <button class="btn-back" (click)="volver()" title="Volver">
      â†
    </button>

    <!-- INFORMACIÃ“N DEL OTRO USUARIO -->
<div class="header-usuario" *ngIf="otroUsuario && !cargandoUsuario">
  
  <!-- Avatar -->
  <img 
    *ngIf="otroUsuario.foto_url"
    [src]="otroUsuario.foto_url"
    class="avatar-header"
    (error)="onImageError($event)"
  />

  <div *ngIf="!otroUsuario.foto_url" class="avatar-header avatar-placeholder">
    {{ obtenerIniciales() }}
  </div>

  <!-- Nombre y rol -->
  <div class="header-info">
    <h2>{{ obtenerNombreCompleto() }}</h2>

    <span class="estado-usuario">
      <ng-container *ngIf="rolUsuario === 'cliente'; else rolCliente">
        ğŸ’ª Entrenador
      </ng-container>

      <ng-template #rolCliente>
        ğŸ‘¤ Cliente
      </ng-template>
    </span>
  </div>
</div>


<!-- ESTADO CARGANDO -->
<div class="header-usuario cargando" *ngIf="cargandoUsuario">
  <div class="avatar-header avatar-placeholder">
    <span class="spinner-mini"></span>
  </div>

  <div class="header-info">
    <h2>Cargando...</h2>
    <span class="estado-usuario">Obteniendo informaciÃ³n</span>
  </div>
</div>


    <!-- BotÃ³n de recargar -->
    <button class="btn-icon" (click)="recargar()" title="Actualizar">
      ğŸ”„
    </button>
  </div>

  <!-- Ãrea de mensajes -->
  <div class="chat-mensajes" #chatContainer>
    <!-- Loading -->
    <div *ngIf="cargando" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Cargando mensajes...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !cargando" class="error-container">
      <span class="error-icon">âš ï¸</span>
      <p>{{ error }}</p>
      <button class="btn-primary" (click)="recargar()">Reintentar</button>
    </div>

    <!-- Mensajes agrupados por fecha -->
    <div *ngIf="!cargando && !error" class="mensajes-lista">
      <div *ngFor="let grupo of agruparMensajesPorFecha()" class="grupo-fecha">
        <!-- Separador de fecha -->
        <div class="fecha-separador">
          <span>{{ grupo.fecha }}</span>
        </div>

        <!-- Mensajes del dÃ­a -->
        <div 
          *ngFor="let mensaje of grupo.mensajes" 
          class="mensaje-wrapper"
          [class.mensaje-mio]="esMensajeMio(mensaje)"
          [class.mensaje-otro]="!esMensajeMio(mensaje)"
        >
          <div class="mensaje-bubble">
            <p class="mensaje-contenido">{{ mensaje.contenido }}</p>
            
            <div class="mensaje-footer">
              <span class="mensaje-hora">{{ formatearHora(mensaje.fecha_envio) }}</span>
              
              <!-- Check marks para mensajes propios -->
              <span *ngIf="esMensajeMio(mensaje)" class="mensaje-estado">
                {{ mensaje.leido ? 'âœ“âœ“' : 'âœ“' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje inicial cuando no hay mensajes -->
      <div *ngIf="mensajes.length === 0" class="empty-chat">
        <div class="empty-icon">ğŸ’¬</div>
        <p>Inicia la conversaciÃ³n con <strong>{{ obtenerNombreCompleto() }}</strong> enviando un mensaje</p>
      </div>
    </div>
  </div>

  <!-- Ãrea de entrada de mensaje -->
  <div class="chat-input-container">
    <div class="input-wrapper">
      <textarea
        [(ngModel)]="nuevoMensaje"
        (keydown)="onKeyPress($event)"
        [placeholder]="'Escribe un mensaje a ' + obtenerNombreCompleto() + '...'"
        class="mensaje-input"
        rows="1"
        [disabled]="enviando"
      ></textarea>
      
      <button 
        class="btn-send"
        (click)="enviarMensaje()"
        [disabled]="!nuevoMensaje.trim() || enviando"
        [title]="enviando ? 'Enviando...' : 'Enviar mensaje (Enter)'"
      >
        <span *ngIf="!enviando">ğŸ“¤</span>
        <span *ngIf="enviando" class="spinner-small"></span>
      </button>
    </div>
  </div>
</div>

