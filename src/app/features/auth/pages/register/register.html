<div class="register-container">
  <!-- Columna izquierda: imagen tipo login -->
  <div class="register-banner">
    <img src="assets/gym-banner_page.jpg" alt="Banner" class="banner-img" />
    <div class="banner-overlay"></div>
  </div>

  <!-- Columna derecha: formulario (scrollea) -->
  <div class="register-form-section">
    <h2 class="register-title">Registro de usuario</h2>

    <form class="register-form" (ngSubmit)="onSubmit()" novalidate>
      <!-- Error general del servidor -->
      <div class="error-msg" *ngIf="formErrors.general">
        {{ formErrors.general }}
      </div>

      <!-- NOMBRE -->
      <div class="field"
           [ngClass]="{
             'invalid': ((nombreCtrl && nombreCtrl.invalid && (nombreCtrl.touched || submitted)) || formErrors.nombre),
             'valid':   (nombreCtrl && nombreCtrl.valid && (nombreCtrl.touched || submitted))
           }">
        <input class="control"
               type="text"
               name="nombre"
               [(ngModel)]="nombre"
               placeholder="Nombres"
               required
               minlength="2"
               autocomplete="given-name"
               #nombreCtrl="ngModel" />
        <div class="error-msg"
             *ngIf="(nombreCtrl && nombreCtrl.invalid && (nombreCtrl.touched || submitted)) || formErrors.nombre">
          <span *ngIf="formErrors.nombre; else nombreAuto">{{ formErrors.nombre }}</span>
          <ng-template #nombreAuto>
            <span *ngIf="nombreCtrl && nombreCtrl.errors?.['required']">Ingresa tu nombre.</span>
            <span *ngIf="nombreCtrl && nombreCtrl.errors?.['minlength']">Debe tener al menos 2 caracteres.</span>
          </ng-template>
        </div>
      </div>

      <!-- APELLIDOS -->
      <div class="field"
           [ngClass]="{
             'invalid': ((apellidoCtrl && apellidoCtrl.invalid && (apellidoCtrl.touched || submitted)) || formErrors.apellido),
             'valid':   (apellidoCtrl && apellidoCtrl.valid && (apellidoCtrl.touched || submitted))
           }">
        <input class="control"
               type="text"
               name="apellido"
               [(ngModel)]="apellido"
               placeholder="Apellidos"
               required
               minlength="2"
               autocomplete="family-name"
               #apellidoCtrl="ngModel" />
        <div class="error-msg"
             *ngIf="(apellidoCtrl && apellidoCtrl.invalid && (apellidoCtrl.touched || submitted)) || formErrors.apellido">
          <span *ngIf="formErrors.apellido; else apellidoAuto">{{ formErrors.apellido }}</span>
          <ng-template #apellidoAuto>
            <span *ngIf="apellidoCtrl && apellidoCtrl.errors?.['required']">Ingresa tus apellidos.</span>
            <span *ngIf="apellidoCtrl && apellidoCtrl.errors?.['minlength']">Debe tener al menos 2 caracteres.</span>
          </ng-template>
        </div>
      </div>

      <!-- EMAIL CON VALIDACIÓN EN TIEMPO REAL -->
      <div class="field"
           [ngClass]="{
             'invalid': ((emailCtrl && emailCtrl.invalid && (emailCtrl.touched || submitted)) || formErrors.email || (!emailIsAvailable && emailCtrl && emailCtrl.touched)),
             'valid':   (emailCtrl && emailCtrl.valid && emailIsValid && emailIsAvailable && (emailCtrl.touched || submitted))
           }">
        <div class="email-input-wrapper">
          <input class="control"
                 type="email"
                 name="email"
                 [(ngModel)]="email"
                 placeholder="E-Mail"
                 required
                 email
                 autocomplete="email"
                 (blur)="checkEmail()"
                 (change)="checkEmail()"
                 #emailCtrl="ngModel" />
          
          <!-- Spinner mientras se valida -->
          <span class="email-validating" *ngIf="emailCheckStatus === 'validando'">
            ⏳
          </span>
        </div>

        <!-- Mensaje de validación exitosa -->
        <div class="email-check-success" *ngIf="emailIsValid && emailIsAvailable && emailCheckStatus !== 'validando' && email">
          ✓ Email disponible
        </div>

        <!-- Mensaje de error en validación -->
        <div class="error-msg"
             *ngIf="(emailCtrl && emailCtrl.invalid && (emailCtrl.touched || submitted)) || formErrors.email || (!emailIsAvailable && emailCtrl && emailCtrl.touched)">
          <span *ngIf="formErrors.email; else emailAuto">{{ formErrors.email }}</span>
          <ng-template #emailAuto>
            <span *ngIf="emailCtrl && emailCtrl.errors?.['required']">Ingresa tu email.</span>
            <span *ngIf="emailCtrl && emailCtrl.errors?.['email']">Formato de email inválido.</span>
            <span *ngIf="emailCheckStatus === 'existente'">Este email ya está registrado.</span>
          </ng-template>
        </div>
      </div>

      <!-- PASSWORD -->
      <div class="field"
           [ngClass]="{
             'invalid': (((passwordTouched || submitted) && !isPasswordValid()) || formErrors.password),
             'valid':   (isPasswordValid() && (passwordTouched || submitted))
           }">

        <input class="control"
               type="password"
               name="password"
               [(ngModel)]="password"
               placeholder="Contraseña"
               autocomplete="new-password"
               required
               aria-describedby="password-help"
               (input)="passwordTouched = true"
               (blur)="passwordTouched = true" />

        <!-- Mensaje rojo SOLO si hay error e interacción -->
        <div class="error-msg"
             *ngIf="(((passwordTouched || submitted) && !isPasswordValid()) || formErrors.password)">
          {{ formErrors.password || 'La contraseña no cumple con los requisitos.' }}
        </div>

        <!-- Barra + requisitos: solo cuando hay interacción y es inválida -->
        <ng-container *ngIf="(passwordTouched || submitted) && password && !isPasswordValid()">
          <div class="strength" [ngClass]="strengthClass()">
            <div class="strength-top">
              <span id="password-help" class="strength-label">Fuerza: {{ strengthLabel() }}</span>
              <span class="strength-min">Mínimo 10 carac.</span>
            </div>
            <div class="meter">
              <div class="meter-bar" [style.width.%]="passwordScorePercent()"></div>
            </div>
          </div>

          <ul class="policy-list">
            <li class="policy-item" [class.ok]="hasUpper()">Mayúscula (A-Z)</li>
            <li class="policy-item" [class.ok]="hasLower()">Minúscula (a-z)</li>
            <li class="policy-item" [class.ok]="hasDigit()">Número (0-9)</li>
            <li class="policy-item" [class.ok]="hasSpecial()">Símbolo (p. ej. !@#$%)</li>
            <li class="policy-item" [class.ok]="hasMinLen()">Mínimo 10 caracteres</li>
          </ul>
        </ng-container>
      </div>

      <!-- CONFIRM PASSWORD -->
      <div class="field"
           [ngClass]="{
             'invalid': (((confirmTouched || submitted) && password !== confirmPassword) || formErrors.confirmPassword),
             'valid':   (confirmPassword && password === confirmPassword && (confirmTouched || submitted))
           }">
        <input class="control"
               type="password"
               name="confirmPassword"
               [(ngModel)]="confirmPassword"
               placeholder="Confirmar contraseña"
               required
               autocomplete="new-password"
               (input)="confirmTouched = true"
               (blur)="confirmTouched = true" />
        <div class="error-msg"
             *ngIf="(((confirmTouched || submitted) && password !== confirmPassword) || formErrors.confirmPassword)">
          {{ formErrors.confirmPassword || 'Las contraseñas no coinciden.' }}
        </div>
      </div>

      <!-- ROL -->
      <div class="field"
           [ngClass]="{
             'invalid': (((roleTouched || submitted) && !selectedRole) || formErrors.rol),
             'valid':   (!!selectedRole && (roleTouched || submitted))
           }">
        <select class="control"
                name="selectedRole"
                [(ngModel)]="selectedRole"
                required
                (blur)="roleTouched = true"
                (change)="roleTouched = true"
                #roleCtrl="ngModel">
          <option value="" disabled>Tipo de usuario</option>
          <option value="alumno">Alumno</option>
          <option value="entrenador">Entrenador</option>
        </select>
        <div class="error-msg" *ngIf="((roleTouched || submitted) && !selectedRole) || formErrors.rol">
          {{ formErrors.rol || 'Selecciona un tipo de usuario.' }}
        </div>
      </div>

      <!-- Separador -->
      <div class="divider-form"></div>
      <span class="login-google-label">Inicia sesión con</span>

      <!-- Botón de Google -->
      <div class="google-wrap">
        <div #googleSignInBtn id="googleSignInBtn"></div>
      </div>

      <!-- Botón sticky -->
      <div class="form-actions">
        <button
          type="submit"
          class="continue-btn"
          [disabled]="!nombre || !apellido || !email || !emailIsValid || !emailIsAvailable || !selectedRole || !isPasswordValid() || password !== confirmPassword">
          Continuar
        </button>
      </div>
    </form>
  </div>
</div>