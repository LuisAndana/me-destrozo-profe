<section class="perfil">
  <!-- ðŸŒˆ Encabezado del perfil -->
  <div class="cover">
    <div class="cover-gradient"></div>

    <div class="cover-inner container">
      <div class="avatar-wrap">
        <!-- Imagen del avatar o foto cargada -->
        <img
          *ngIf="(previewUrl() || perfil()?.fotoUrl) as img"
          class="avatar"
          [ngSrc]="img"
          width="120"
          height="120"
          alt="Avatar"
        />

        <!-- Fallback con inicial si no hay foto -->
        <div *ngIf="!(previewUrl() || perfil()?.fotoUrl)" class="avatar avatar-fallback">
          {{ (perfil()?.nombre || 'U').slice(0, 1) }}
        </div>

        <button class="btn btn-outline btn-sm" type="button" (click)="seleccionarAvatar(fileInput)">
          Cambiar foto
        </button>
        <input
          #fileInput
          type="file"
          accept="image/*"
          class="hide"
          (change)="onFileSelected($event)"
        />
      </div>

      <div class="title-wrap">
        <h1>{{ form.value.nombre || perfil()?.nombre || 'Tu perfil' }}</h1>
        <p class="muted">{{ perfil()?.email }}</p>

        <div class="chips">
          <span class="chip" *ngIf="form.value.edad">Edad: {{ form.value.edad }}</span>
          <span class="chip" *ngIf="form.value.pesoKg">Peso: {{ form.value.pesoKg }} kg</span>
          <span class="chip" *ngIf="form.value.estaturaCm">Estatura: {{ form.value.estaturaCm }} cm</span>
          <span class="chip attention" *ngIf="imc() !== null">IMC: {{ imc() }}</span>
        </div>
      </div>

      <div class="actions-top">
        <button class="btn btn-primary" type="button" [disabled]="guardando()" (click)="guardar()">
          Guardar cambios
        </button>
        <button class="btn btn-ghost" type="button" (click)="cambiosOpen.set(true)">
          Ver cambios
        </button>
        <a class="btn btn-secondary" routerLink="/progreso">Ver progreso</a>
      </div>
    </div>
  </div>

  <!-- ðŸŒ¿ Contenedor principal -->
  <div class="container layout">
    <!-- Panel lateral -->
    <aside class="aside">
      <div class="card sticky">
        <h3>Resumen</h3>
        <ul class="summary">
          <li><span>Nombre</span><strong>{{ form.value.nombre || perfil()?.nombre || 'â€”' }}</strong></li>
          <li><span>Sexo</span><strong>{{ form.value.sexo || 'â€”' }}</strong></li>
          <li><span>Edad</span><strong>{{ form.value.edad || 'â€”' }}</strong></li>
          <li><span>Peso</span><strong>{{ form.value.pesoKg || 'â€”' }} kg</strong></li>
          <li><span>Estatura</span><strong>{{ form.value.estaturaCm || 'â€”' }} cm</strong></li>
          <li><span>IMC</span><strong>{{ imc() ?? 'â€”' }}</strong></li>
        </ul>
        <div class="aside-actions">
          <button class="btn btn-primary btn-block" type="button" [disabled]="guardando()" (click)="guardar()">
            Guardar
          </button>
          <button class="btn btn-outline btn-block" type="button" (click)="cambiosOpen.set(true)">
            Cambios
          </button>
        </div>
      </div>

      <div class="card">
        <h3>Tips</h3>
        <p class="muted">
          MantÃ©n tus datos actualizados para mejorar tus rutinas y el seguimiento personalizado.
        </p>
      </div>
    </aside>

    <!-- ðŸ“ Formulario principal -->
    <form class="grid" [formGroup]="form" (ngSubmit)="guardar()">
      <!-- Datos personales -->
      <div class="card glass">
        <h3>Datos personales</h3>
        <label>Nombre
          <input type="text" formControlName="nombre" placeholder="Tu nombre" />
        </label>
        <label>Sexo
          <select formControlName="sexo">
            <option value="">Seleccionar</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </label>
        <label>Edad
          <input type="number" min="0" formControlName="edad" placeholder="AÃ±os" />
        </label>
      </div>

      <!-- Medidas -->
      <div class="card glass">
        <h3>Medidas</h3>
        <label>Peso (kg)
          <input type="number" formControlName="pesoKg" step="0.1" min="0" placeholder="Ej. 64.5" />
        </label>
        <label>Estatura (cm)
          <input type="number" formControlName="estaturaCm" step="0.1" min="0" placeholder="Ej. 172" />
        </label>
        <div class="imc">
          <span>IMC estimado:</span>
          <strong *ngIf="imc() !== null; else imcNulo">{{ imc() }}</strong>
          <ng-template #imcNulo><span class="muted">â€”</span></ng-template>
        </div>
      </div>

      <!-- Salud -->
      <div class="card glass">
        <h3>Salud</h3>
        <label>Problemas / Observaciones
          <textarea rows="5" formControlName="problemas" placeholder="Describe lesiones, dificultades, etc."></textarea>
        </label>
        <label>Enfermedades
          <input type="text" formControlName="enfermedades" placeholder="Diabetes, HipertensiÃ³n, ..." />
        </label>
      </div>

      <!-- Botones principales -->
      <div class="full actions-bottom">
        <button class="btn btn-primary" type="submit" [disabled]="guardando()">Guardar cambios</button>
        <button class="btn btn-ghost" type="button" (click)="cambiosOpen.set(true)">Ver cambios</button>
        <a class="btn btn-secondary" routerLink="/progreso">Ver progreso</a>
      </div>

      <!-- ðŸ•“ Cambios -->
      <div class="card full">
        <h3>Ãšltimos cambios</h3>
        <ul class="timeline" *ngIf="cambios().length; else noCambios">
          <li *ngFor="let c of cambios()">
            <div class="dot"></div>
            <div class="row">
              <div class="when">{{ c.fecha | date: 'medium' }}</div>
              <div class="what">{{ c.campo }}</div>
              <div class="fromto">
                <span class="from">{{ c.antes ?? 'â€”' }}</span>
                <span class="arrow">â†’</span>
                <span class="to">{{ c.despues ?? 'â€”' }}</span>
              </div>
            </div>
          </li>
        </ul>
        <ng-template #noCambios>
          <p class="muted">No hay cambios registrados.</p>
        </ng-template>
      </div>
    </form>
  </div>

  <!-- ðŸªŸ Modal -->
  <div class="modal" *ngIf="cambiosOpen()">
    <div class="modal-card">
      <header>
        <h3>Historial de cambios</h3>
        <button class="icon" type="button" (click)="cambiosOpen.set(false)">âœ•</button>
      </header>
      <ul class="changes">
        <li *ngFor="let c of cambios()">
          <div class="when">{{ c.fecha | date: 'medium' }}</div>
          <div class="field">{{ c.campo }}</div>
          <div class="fromto">
            <span class="from">{{ c.antes ?? 'â€”' }}</span>
            <span class="arrow">â†’</span>
            <span class="to">{{ c.despues ?? 'â€”' }}</span>
          </div>
        </li>
        <li *ngIf="!cambios().length" class="muted">Sin cambios aÃºn.</li>
      </ul>
    </div>
    <div class="backdrop" (click)="cambiosOpen.set(false)"></div>
  </div>
</section>
