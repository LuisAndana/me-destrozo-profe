<!-- proceso-pago.page.html -->

<div class="pago-container">
  <!-- Header -->
  <div class="pago-header">
    <div class="container-header">
      <a class="btn-volver" routerLink="/entrenadores" [queryParams]="{ id: entrenador?.id }">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Volver
      </a>
      <h1>Proceso de Pago</h1>
      <div></div>
    </div>
  </div>

  <!-- Contenido Principal -->
  <div class="pago-content">
    <!-- Loading -->
    <div *ngIf="cargandoEntrenador" class="estado-loading">
      <div class="spinner"></div>
      <p>Cargando datos del entrenador...</p>
    </div>

    <!-- Error al cargar entrenador -->
    <div *ngIf="errorEntrenador && !cargandoEntrenador" class="estado-error">
      <div class="error-icon">❌</div>
      <h2>Error</h2>
      <p>{{ errorEntrenador }}</p>
      <button class="btn-volver-error" (click)="cancelarPago()">Volver a Entrenadores</button>
    </div>

    <!-- Contenido del Pago -->
    <div *ngIf="entrenador && !cargandoEntrenador && !errorEntrenador" class="pago-main">
      <!-- Indicador de Pasos -->
      <div class="pasos-container">
        <div class="paso" [class.activo]="pasoPago >= 1" [class.completado]="pasoPago > 1">
          <div class="numero">1</div>
          <div class="etiqueta">Datos</div>
        </div>
        <div class="linea" [class.activo]="pasoPago > 1"></div>
        <div class="paso" [class.activo]="pasoPago >= 2" [class.completado]="pasoPago > 2">
          <div class="numero">2</div>
          <div class="etiqueta">Confirmación</div>
        </div>
        <div class="linea" [class.activo]="pasoPago > 2"></div>
        <div class="paso" [class.activo]="pasoPago >= 3" [class.completado]="pasoPago > 3">
          <div class="numero">3</div>
          <div class="etiqueta">Pago</div>
        </div>
      </div>

      <div class="contenido-pago">
        <!-- PASO 1: DATOS DE PAGO -->
        <div class="paso-contenido" *ngIf="pasoPago === 1">
          <h2>Ingresa los datos de tu tarjeta</h2>
          
          <form class="formulario-pago">
            <!-- Número de Tarjeta -->
            <div class="form-group">
              <label for="numeroTarjeta">Número de Tarjeta</label>
              <div class="input-wrapper">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                  <path d="M1 8h22"/>
                </svg>
                <input 
                  id="numeroTarjeta"
                  type="text" 
                  placeholder="1234 5678 9012 3456"
                  [(ngModel)]="formPago.numeroTarjeta"
                  (input)="formatearTarjeta($event)"
                  maxlength="19"
                  name="numeroTarjeta"
                />
              </div>
            </div>

            <!-- Titular -->
            <div class="form-group">
              <label for="titular">Nombre del Titular</label>
              <div class="input-wrapper">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <input 
                  id="titular"
                  type="text" 
                  placeholder="Juan Pérez"
                  [(ngModel)]="formPago.titular"
                  name="titular"
                />
              </div>
            </div>

            <!-- Fila: Mes/Año y CVV -->
            <div class="form-row">
              <div class="form-group">
                <label for="mesExpiracion">Mes</label>
                <div class="input-wrapper">
                  <input 
                    id="mesExpiracion"
                    type="text" 
                    placeholder="MM"
                    [(ngModel)]="formPago.mesExpiracion"
                    (input)="soloNumeros($event)"
                    maxlength="2"
                    name="mesExpiracion"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="anoExpiracion">Año</label>
                <div class="input-wrapper">
                  <input 
                    id="anoExpiracion"
                    type="text" 
                    placeholder="YY"
                    [(ngModel)]="formPago.anoExpiracion"
                    (input)="soloNumeros($event)"
                    maxlength="2"
                    name="anoExpiracion"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="cvv">CVV</label>
                <div class="input-wrapper">
                  <input 
                    id="cvv"
                    type="text" 
                    placeholder="123"
                    [(ngModel)]="formPago.cvv"
                    (input)="soloNumeros($event)"
                    maxlength="3"
                    name="cvv"
                  />
                </div>
              </div>
            </div>

            <!-- Información de precio -->
            <div class="precio-info">
              <div class="item">
                <span>Entrenador:</span>
                <strong>{{ entrenador.nombre }}</strong>
              </div>
              <div class="item">
                <span>Especialidad:</span>
                <strong>{{ entrenador.especialidad }}</strong>
              </div>
              <div class="divisor"></div>
              <div class="item total">
                <span>Total a pagar (mensual):</span>
                <strong>${{ precioFormateado }} MXN</strong>
              </div>
            </div>

            <!-- Error de formulario -->
            <div *ngIf="errorFormulario" class="error-msg">
              ⚠️ {{ errorFormulario }}
            </div>
          </form>
        </div>

        <!-- PASO 2: CONFIRMACIÓN -->
        <div class="paso-contenido" *ngIf="pasoPago === 2">
          <h2>Confirma tu pago</h2>
          
          <div class="resumen-pago">
            <div class="seccion">
              <h3>Detalles de la Tarjeta</h3>
              <div class="detalle">
                <span>Tarjeta terminada en:</span>
                <strong>•••• •••• •••• {{ ultimosDigitos }}</strong>
              </div>
              <div class="detalle">
                <span>Titular:</span>
                <strong>{{ formPago.titular }}</strong>
              </div>
              <div class="detalle">
                <span>Vencimiento:</span>
                <strong>{{ formPago.mesExpiracion }}/{{ formPago.anoExpiracion }}</strong>
              </div>
            </div>

            <div class="seccion">
              <h3>Detalles del Entrenador</h3>
              <div class="detalle-entrenador">
                <img *ngIf="entrenador.foto_url" 
                     [src]="entrenador.foto_url" 
                     [alt]="entrenador.nombre"
                     class="foto-entrenador" />
                <div class="info-entrenador">
                  <div class="nombre">{{ entrenador.nombre }}</div>
                  <div class="especialidad">{{ entrenador.especialidad }}</div>
                </div>
              </div>
            </div>

            <div class="seccion">
              <h3>Monto a Pagar</h3>
              <div class="monto-total">
                <strong>${{ precioFormateado }} MXN</strong>
                <span class="periodo">por mes</span>
              </div>
            </div>

            <div class="seccion info">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
              <span>Este es un pago académico ficticio. No se debitará dinero real.</span>
            </div>
          </div>
        </div>

        <!-- PASO 3: PROCESANDO/ÉXITO -->
        <div class="paso-contenido" *ngIf="pasoPago === 3">
          <div class="procesando-pago">
            <div *ngIf="!pagoProcesado" class="loader">
              <div class="spinner"></div>
              <h2>Procesando pago...</h2>
              <p>Por favor espera mientras confirmamos tu transacción</p>
            </div>

            <div *ngIf="pagoProcesado && !errorContratacion" class="exito-pago">
              <div class="icono-exito">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <h2>¡Pago Exitoso!</h2>
              <p>Tu contratación se está completando</p>
              <div class="detalles-exito">
                <div class="item">
                  <span>Transacción ID:</span>
                  <strong>{{ idTransaccion }}</strong>
                </div>
                <div class="item">
                  <span>Monto pagado:</span>
                  <strong>${{ precioFormateado }} MXN</strong>
                </div>
                <div class="item">
                  <span>Entrenador:</span>
                  <strong>{{ entrenador.nombre }}</strong>
                </div>
              </div>
              <p class="info-redireccion">Redirigiendo a la página del entrenador...</p>
            </div>

            <div *ngIf="errorContratacion" class="error-contratacion">
              <div class="error-icon">❌</div>
              <h2>Error en la Contratación</h2>
              <p>{{ errorContratacion }}</p>
              <button class="btn-reintentar" (click)="volver()">Reintentar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de Navegación -->
      <div class="pago-footer">
        <button 
          class="btn-secundario" 
          (click)="pasoPago === 1 ? cancelarPago() : volver()"
          [disabled]="procesandoPago || contratandoEntrenador"
          type="button">
          {{ pasoPago === 1 ? 'Cancelar' : 'Atrás' }}
        </button>

        <button 
          class="btn-primario" 
          (click)="continuarPago()"
          [disabled]="procesandoPago || pagoProcesado || contratandoEntrenador"
          type="button">
          <span *ngIf="pasoPago === 1">Continuar</span>
          <span *ngIf="pasoPago === 2">Pagar Ahora</span>
          <span *ngIf="pasoPago === 3 && procesandoPago">Procesando...</span>
          <span *ngIf="pasoPago === 3 && pagoProcesado && !errorContratacion">Completado</span>
        </button>
      </div>
    </div>
  </div>
</div>