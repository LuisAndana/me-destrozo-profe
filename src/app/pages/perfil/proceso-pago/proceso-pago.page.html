<div class="pago-container">
  <!-- Header -->
  <div class="pago-header">
    <div class="container-header">
      <a class="btn-volver" routerLink="/entrenadores" [queryParams]="{ id: entrenador?.id }">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Volver
      </a>
      <h1>Proceso de Pago</h1>
      <div></div>
    </div>
  </div>

  <!-- Stripe Element GLOBAL (nunca se destruye) -->
  <div id="stripe-global" style="height:0; opacity:0; overflow:hidden; pointer-events:none;">
    <div id="card-element"></div>
    <div id="card-errors"></div>
  </div>

  <!-- Contenido Principal -->
  <div class="pago-content">
    
    <!-- Loading -->
    <div *ngIf="cargandoEntrenador" class="estado-loading">
      <div class="spinner"></div>
      <p>Cargando datos del entrenador...</p>
    </div>

    <!-- Error al cargar entrenador -->
    <div *ngIf="errorEntrenador && !cargandoEntrenador" class="estado-error">
      <div class="error-icon">❌</div>
      <h2>Error</h2>
      <p>{{ errorEntrenador }}</p>
      <button class="btn-volver-error" (click)="cancelarPago()">Volver</button>
    </div>

    <!-- Contenido del Pago -->
    <div *ngIf="entrenador && !cargandoEntrenador && !errorEntrenador" class="pago-main">

      <!-- Indicador de pasOS -->
      <div class="pasos-container">
        <div class="paso" [class.activo]="pasoPago >= 1" [class.completado]="pasoPago > 1">
          <div class="numero">1</div><div class="etiqueta">Datos</div>
        </div>
        <div class="linea" [class.activo]="pasoPago > 1"></div>

        <div class="paso" [class.activo]="pasoPago >= 2" [class.completado]="pasoPago > 2">
          <div class="numero">2</div><div class="etiqueta">Confirmación</div>
        </div>
        <div class="linea" [class.activo]="pasoPago > 2"></div>

        <div class="paso" [class.activo]="pasoPago >= 3" [class.completado]="pasoPago > 3">
          <div class="numero">3</div><div class="etiqueta">Pago</div>
        </div>
      </div>

      <div class="contenido-pago">

        <!-- ============================= -->
        <!--   PASO 1 — INGRESO DE DATOS   -->
        <!-- ============================= -->
        
          <h2>Ingresa los datos de tu tarjeta</h2>

          <form class="formulario-pago">

            <!-- Titular -->
            <div class="form-group">
              <label>Nombre del Titular</label>
              <div class="input-wrapper">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <input type="text" placeholder="Juan Pérez"
                  [(ngModel)]="formPago.titular" name="titular"/>
              </div>
            </div>

            <!-- Stripe Card Element visible -->
            <div class="form-group">
              <label>Tarjeta de Crédito / Débito</label>

              <div id="stripe-visible"></div>

                <!-- Aquí insertamos el card-element que está montado invisible -->
              </div>
            

            <!-- Precio -->
            <div class="precio-info">
              <div class="item">
                <span>Entrenador:</span><strong>{{ entrenador.nombre }}</strong>
              </div>
              <div class="item">
                <span>Especialidad:</span><strong>{{ entrenador.especialidad }}</strong>
              </div>
              <div class="item">
                <span>Total (mensual):</span><strong>${{ precioFormateado }} MXN</strong>
              </div>
            </div>

            <div *ngIf="errorFormulario" class="error-msg">⚠️ {{ errorFormulario }}</div>
          </form>
        </div>


        <!-- ============================= -->
        <!--     PASO 2 — CONFIRMACIÓN     -->
        <!-- ============================= -->
        <div class="paso-contenido" *ngIf="pasoPago === 2">
          <h2>Confirma tu pago</h2>

          <p>Tarjeta terminada en: <strong>{{ ultimosDigitos }}</strong></p>
          <p>Titular: <strong>{{ formPago.titular }}</strong></p>
          
          <p>Monto a pagar: <strong>${{ precioFormateado }} MXN</strong></p>
        </div>


        <!-- ============================= -->
        <!--      PASO 3 — PROCESANDO      -->
        <!-- ============================= -->
        <div class="paso-contenido" *ngIf="pasoPago === 3">

          <div *ngIf="!pagoProcesado">
            <div class="spinner"></div>
            <h2>Procesando pago…</h2>
            <p>Por favor espera...</p>
          </div>

          <div *ngIf="pagoProcesado && !errorContratacion" class="exito-pago">
            <h2>¡Pago exitoso!</h2>
            <p>Transacción: {{ idTransaccion }}</p>
          </div>

          <div *ngIf="errorContratacion">
            <h2>Error</h2>
            <p>{{ errorContratacion }}</p>
            <button (click)="volver()">Reintentar</button>
          </div>

        </div>
      </div>

      <!-- Botones inferiores -->
      <div class="pago-footer">
        <button class="btn-secundario" (click)="pasoPago === 1 ? cancelarPago() : volver()">Atrás</button>
        <button class="btn-primario" (click)="continuarPago()">
          {{ pasoPago === 1 ? 'Continuar' : pasoPago === 2 ? 'Pagar Ahora' : 'Procesando...' }}
        </button>
      </div>
    </div>
  </div>

