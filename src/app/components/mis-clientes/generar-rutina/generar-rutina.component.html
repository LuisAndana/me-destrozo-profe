<div class="container-generar">
  <div class="content-wrapper">
    <!-- Panel izquierdo: Formulario -->
    <div class="left-panel">
      <h2>1. Seleccionar Alumno</h2>
      <div class="alumnos-list">
        <div
          *ngFor="let alumno of alumnos"
          class="alumno-item"
          [class.selected]="alumnoSeleccionado?.id_usuario === alumno.id_usuario"
          (click)="seleccionarAlumno(alumno)"
        >
          <span class="alumno-nombre">{{ getNombreAlumno(alumno) }}</span>
        </div>
        <p *ngIf="cargandoAlumnos" class="loading-message">Cargando alumnos...</p>
        <p *ngIf="!cargandoAlumnos && alumnos.length === 0" class="empty-message">
          No hay alumnos disponibles
        </p>
      </div>

      <h2>2. Par√°metros de la Rutina</h2>

      <div class="form-section">
        <!-- OBJETIVO PRINCIPAL -->
        <div class="form-group">
          <label>Objetivo Principal *</label>
          <select [(ngModel)]="parametros.objetivo" class="select">
            <option value="">Seleccionar objetivo...</option>
            <option value="hipertrofia">üí™ Ganar masa muscular (Hipertrofia)</option>
            <option value="fuerza">üèãÔ∏è Aumentar fuerza</option>
            <option value="resistencia">üèÉ Mejorar resistencia</option>
            <option value="perdida_grasa">üî• P√©rdida de grasa</option>
            <option value="tonificacion">‚ú® Tonificaci√≥n general</option>
            <option value="gluteos">üçë Enfoque en gl√∫teos</option>
            <option value="funcional">‚ö° Entrenamiento funcional</option>
          </select>
        </div>

        <!-- LUGAR DE ENTRENAMIENTO -->
        <div class="form-group">
          <label>Lugar de Entrenamiento *</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" [(ngModel)]="parametros.lugar" value="gimnasio" name="lugar">
              <span class="radio-label">üè¢ Gimnasio</span>
            </label>
            <label class="radio-option">
              <input type="radio" [(ngModel)]="parametros.lugar" value="casa" name="lugar">
              <span class="radio-label">üè† Casa</span>
            </label>
            <label class="radio-option">
              <input type="radio" [(ngModel)]="parametros.lugar" value="parque" name="lugar">
              <span class="radio-label">üå≥ Parque/Exterior</span>
            </label>
          </div>
        </div>

        <!-- EQUIPAMIENTO DISPONIBLE -->
        <div class="form-group">
          <label>Equipamiento Disponible *</label>
          <div class="chips-container">
            <label *ngFor="let equipo of opcionesEquipamiento" class="chip-option">
              <input 
                type="checkbox" 
                [value]="equipo.value"
                (change)="toggleEquipamiento(equipo.value)"
                [checked]="parametros.equipamiento.includes(equipo.value)">
              <span class="chip-label">{{ equipo.icon }} {{ equipo.label }}</span>
            </label>
          </div>
          <small *ngIf="parametros.equipamiento.length === 0" class="text-warning">
            ‚ö†Ô∏è Sin equipo = ejercicios de peso corporal
          </small>
        </div>

        <!-- TIEMPO DISPONIBLE -->
        <div class="form-group">
          <label>Tiempo por Sesi√≥n *</label>
          <div class="time-selector">
            <button 
              type="button"
              *ngFor="let tiempo of opcionesTiempo" 
              class="time-btn"
              [class.active]="parametros.tiempo_minutos === tiempo"
              (click)="parametros.tiempo_minutos = tiempo">
              {{ tiempo }} min
            </button>
          </div>
        </div>

        <!-- D√çAS POR SEMANA -->
        <div class="form-group">
          <label for="dias">D√≠as por Semana *</label>
          <select id="dias" [(ngModel)]="diasPorSemana" class="select">
            <option *ngFor="let dia of [2, 3, 4, 5, 6, 7]" [value]="dia">
              {{ dia }} d√≠as
            </option>
          </select>
        </div>

        <!-- EXPERIENCIA/NIVEL -->
        <div class="form-group">
          <label>Nivel de Experiencia *</label>
          <select [(ngModel)]="parametros.experiencia" class="select">
            <option value="">Seleccionar...</option>
            <option value="principiante">üÜï Principiante (0-6 meses)</option>
            <option value="intermedio">üìà Intermedio (6-24 meses)</option>
            <option value="avanzado">üèÜ Avanzado (2+ a√±os)</option>
          </select>
        </div>

        <!-- GRUPO MUSCULAR FOCO (AHORA OBLIGATORIO) -->
        <div class="form-group">
          <label for="grupo">√ânfasis en Grupo Muscular *</label>
          <select id="grupo" [(ngModel)]="grupoMuscularFoco" class="select">
            <option value="">Seleccionar grupo...</option>
            <option value="general">General (todo el cuerpo)</option>
            <option value="PECHO">Pecho</option>
            <option value="ESPALDA">Espalda</option>
            <option value="PIERNAS">Piernas</option>
            <option value="GL√öTEOS">Gl√∫teos</option>
            <option value="BRAZOS">Brazos</option>
            <option value="HOMBROS">Hombros</option>
            <option value="CORE">Core/Abdomen</option>
            <option value="CARDIO">Cardio</option>
          </select>
          <small>Este grupo muscular tendr√° m√°s ejercicios en la rutina</small>
        </div>

        <!-- NUEVO: DURACI√ìN Y VIGENCIA -->
        <div class="form-group vigencia-section">
          <label>‚è≥ Duraci√≥n de la Rutina *</label>
          <div class="duration-selector">
            <button 
              type="button"
              *ngFor="let duracion of opcionesDuracion" 
              class="duration-btn"
              [class.active]="duracionMeses === duracion"
              (click)="duracionMeses = duracion">
              {{ duracion }} {{ duracion === 1 ? 'mes' : 'meses' }}
            </button>
          </div>
          <small class="duration-description">
            {{ getDescripcionDuracion(duracionMeses) }}
          </small>
        </div>

        <!-- NUEVO: ACTIVACI√ìN INMEDIATA -->
        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="activarVigenciaInmediata"
              class="checkbox-input">
            <span class="checkbox-text">
              üöÄ Activar vigencia inmediatamente
            </span>
          </label>
          <small *ngIf="activarVigenciaInmediata" class="text-success">
            ‚úì La rutina comenzar√° a contar desde hoy hasta: {{ getFechaVencimientoEstimada() }}
          </small>
          <small *ngIf="!activarVigenciaInmediata" class="text-info">
            ‚ÑπÔ∏è La vigencia se activar√° manualmente cuando asignes la rutina al alumno
          </small>
        </div>

        <!-- RESUMEN DE PAR√ÅMETROS -->
        <div class="info-box" *ngIf="alumnoSeleccionado && parametros.objetivo">
          <strong>üìã Resumen de Par√°metros:</strong>
          <ul class="params-summary">
            <li><strong>Alumno:</strong> {{ getNombreAlumno(alumnoSeleccionado) }}</li>
            <li><strong>Objetivo:</strong> {{ getNombreObjetivo(parametros.objetivo) }}</li>
            <li><strong>√ânfasis:</strong> 
              <span *ngIf="grupoMuscularFoco && grupoMuscularFoco !== 'general'" class="emphasis-badge">
                {{ grupoMuscularFoco }}
              </span>
              <span *ngIf="!grupoMuscularFoco || grupoMuscularFoco === 'general'" class="text-muted">
                General (todo el cuerpo)
              </span>
            </li>
            <li><strong>Lugar:</strong> {{ parametros.lugar }}</li>
            <li><strong>Equipamiento:</strong> 
              <span *ngIf="parametros.equipamiento.length > 0">{{ parametros.equipamiento.join(', ') }}</span>
              <span *ngIf="parametros.equipamiento.length === 0" class="text-warning">Sin equipo</span>
            </li>
            <li><strong>Duraci√≥n:</strong> {{ parametros.tiempo_minutos }} minutos</li>
            <li><strong>Frecuencia:</strong> {{ diasPorSemana }} d√≠as/semana</li>
            <li><strong>Nivel:</strong> {{ parametros.experiencia }}</li>
            <li class="vigencia-highlight">
              <strong>‚è≥ Vigencia:</strong> {{ duracionMeses }} {{ duracionMeses === 1 ? 'mes' : 'meses' }}
              <span *ngIf="activarVigenciaInmediata" class="badge-activa">ACTIVA</span>
              <span *ngIf="!activarVigenciaInmediata" class="badge-pendiente">PENDIENTE</span>
            </li>
          </ul>
        </div>

        <div class="info-box">
          <strong>‚ÑπÔ∏è Ejercicios Disponibles:</strong>
          <p>{{ ejerciciosDisponibles.length }} ejercicios cargados de la base de datos</p>
          <p *ngIf="obtenerEjerciciosRecomendados().length > 0">
            {{ obtenerEjerciciosRecomendados().length }} ejercicios para nivel {{ parametros.experiencia }}
          </p>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="button-group">
        <button
          (click)="generarRutina()"
          [disabled]="!formularioValido() || cargandoRutina"
          class="btn btn-primary"
        >
          <span *ngIf="!cargandoRutina">‚ö° Generar Rutina IA</span>
          <span *ngIf="cargandoRutina">Generando...</span>
        </button>
        <button
          (click)="limpiarFormulario()"
          [disabled]="cargandoRutina"
          class="btn btn-secondary"
        >
          Limpiar
        </button>
      </div>

      <!-- Mensajes -->
      <div *ngIf="mensajeError" class="alert alert-error">
        ‚ùå {{ mensajeError }}
      </div>
      <div *ngIf="mensajeExito" class="alert alert-success">
        ‚úÖ {{ mensajeExito }}
      </div>
    </div>

    <!-- Panel derecho: Rutina generada -->
    <div class="right-panel">
      <div *ngIf="!rutinaGenerada && !cargandoRutina" class="placeholder">
        <div class="placeholder-content">
          <p>üìã Configura los par√°metros de entrenamiento</p>
          <p>Luego haz clic en "Generar Rutina IA" para crear una rutina personalizada</p>
        </div>
      </div>

      <div *ngIf="cargandoRutina" class="loading-spinner">
        <div class="spinner"></div>
        <p>Generando rutina personalizada...</p>
      </div>

      <div *ngIf="rutinaGenerada && !cargandoRutina" class="rutina-generada">
        <div class="rutina-header">
          <h2>{{ rutinaGenerada.nombre }}</h2>
          <p class="rutina-descripcion">{{ rutinaGenerada.descripcion }}</p>
          
          <!-- NUEVO: Badge de vigencia -->
          <div class="vigencia-info" *ngIf="rutinaGenerada?.vigencia as vigencia">
            <div class="vigencia-badge" [ngClass]="{
              'vigencia-activa': vigencia.estado === 'activa',
              'vigencia-por-vencer': vigencia.estado === 'por_vencer',
              'vigencia-vencida': vigencia.estado === 'vencida',
              'vigencia-pendiente': vigencia.estado === 'pendiente'
            }">
              <span class="vigencia-icon">‚è≥</span>
              <div class="vigencia-details">
                <span class="vigencia-titulo">
                  {{ vigencia.activada ? 'Vigencia Activa' : 'Vigencia Pendiente' }}
                </span>
                <span class="vigencia-fechas" *ngIf="vigencia.activada">
                  {{ vigencia.fecha_inicio | date:'dd/MM/yyyy' }} - {{ vigencia.fecha_fin | date:'dd/MM/yyyy' }}
                </span>
                <span class="vigencia-duracion" *ngIf="!vigencia.activada">
                  Duraci√≥n: {{ vigencia.duracion_meses }} mes(es)
                </span>
              </div>
            </div>
            
            <!-- Barra de progreso -->
            <div class="vigencia-progress" *ngIf="vigencia.activada">
              <div class="progress-bar-container">
                <div class="progress-bar-fill" 
                     [style.width.%]="vigencia.porcentaje_completado"
                     [ngClass]="{
                       'progress-activa': vigencia.estado === 'activa',
                       'progress-por-vencer': vigencia.estado === 'por_vencer',
                       'progress-vencida': vigencia.estado === 'vencida'
                     }">
                </div>
              </div>
              <div class="progress-info">
                <span class="progress-text">
                  {{ vigencia.dias_restantes }} d√≠as restantes
                </span>
                <span class="progress-percentage">
                  {{ vigencia.porcentaje_completado }}%
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
          <div class="stat-card">
            <strong class="stat-number">{{ rutinaGenerada.total_ejercicios }}</strong>
            <span class="stat-label">Ejercicios</span>
          </div>
          <div class="stat-card">
            <strong class="stat-number">{{ rutinaGenerada.minutos_aproximados }}</strong>
            <span class="stat-label">Minutos</span>
          </div>
          <div class="stat-card">
            <strong class="stat-number">{{ rutinaGenerada.dias_semana }}</strong>
            <span class="stat-label">D√≠as/Semana</span>
          </div>
        </div>

        <!-- Tabs de d√≠as -->
        <div class="tabs-dias-section">
          <h3>Selecciona un d√≠a</h3>
          <div class="tabs-container">
            <button
              *ngFor="let dia of rutinaGenerada.dias; let i = index"
              class="tab-dia"
              [class.tab-activo]="diaSeleccionado === i"
              (click)="cambiarDia(i)"
            >
              {{ dia.nombre_dia }}
            </button>
          </div>
        </div>

        <!-- Contenido del d√≠a -->
        <div class="dia-contenido" *ngIf="obtenerDiaActual()">
          <div class="dia-info">
            <h3 class="dia-nombre">{{ obtenerDiaActual()!.nombre_dia }}</h3>
            <p class="dia-descripcion">{{ obtenerDiaActual()!.descripcion }}</p>
            <p class="dia-enfoque" *ngIf="obtenerDiaActual()!.grupos_enfoque && obtenerDiaActual()!.grupos_enfoque.length > 0">
              <strong>üéØ Grupos musculares:</strong> {{ obtenerDiaActual()!.grupos_enfoque.join(', ') }}
            </p>
          </div>

          <!-- Lista de ejercicios -->
          <div class="ejercicios-section">
            <h3>Ejercicios del d√≠a</h3>
            <div class="ejercicios-list">
              <div
                *ngFor="let ejercicio of obtenerDiaActual()!.ejercicios; let i = index"
                class="ejercicio-card"
              >
                <div class="ejercicio-index">{{ i + 1 }}</div>
                <div class="ejercicio-content">
                  <h4>{{ ejercicio.nombre }}</h4>
                  <p class="ejercicio-descripcion">{{ ejercicio.descripcion }}</p>
                  
                  <!-- Detalles del ejercicio -->
                  <div class="ejercicio-detalles" *ngIf="ejercicio.series || ejercicio.repeticiones || ejercicio.descanso_segundos">
                    <span class="detalle" *ngIf="ejercicio.series">
                      <strong>Series:</strong> {{ ejercicio.series }}
                    </span>
                    <span class="detalle" *ngIf="ejercicio.repeticiones">
                      <strong>Reps:</strong> {{ ejercicio.repeticiones }}
                    </span>
                    <span class="detalle" *ngIf="ejercicio.descanso_segundos">
                      <strong>Descanso:</strong> {{ ejercicio.descanso_segundos }}s
                    </span>
                  </div>

                  <div class="ejercicio-tags">
                    <span class="tag tag-grupo">{{ ejercicio.grupo_muscular }}</span>
                    <span class="tag tag-dificultad">{{ ejercicio.dificultad }}</span>
                    <span class="tag tag-tipo">{{ ejercicio.tipo }}</span>
                  </div>
                  
                  <!-- Notas del ejercicio -->
                  <p class="ejercicio-notas" *ngIf="ejercicio.notas">
                    üìù {{ ejercicio.notas }}
                  </p>
                </div>
              </div>

              <!-- Si no hay ejercicios -->
              <div *ngIf="obtenerDiaActual() && (!obtenerDiaActual()!.ejercicios || obtenerDiaActual()!.ejercicios.length === 0)" class="sin-ejercicios">
                <p>No hay ejercicios para este d√≠a</p>
              </div>
            </div>
          </div>

          <!-- Resumen del d√≠a -->
          <div class="resumen-dia" *ngIf="obtenerDiaActual() && obtenerDiaActual()!.ejercicios && obtenerDiaActual()!.ejercicios.length > 0">
            <p>
              <strong>‚úì Total ejercicios:</strong> {{ obtenerDiaActual()!.ejercicios.length }}
            </p>
            <p>
              <strong>‚è±Ô∏è Tiempo estimado:</strong> {{ calcularTiempoEstimado(obtenerDiaActual()!.ejercicios) }} minutos
            </p>
          </div>
        </div>

        <!-- Acciones -->
        <div class="button-group rutina-actions">
          <button (click)="abrirModalGuardar()" class="btn btn-success" [disabled]="cargandoRutina">
            <span *ngIf="!cargandoRutina">üíæ Guardar Rutina</span>
            <span *ngIf="cargandoRutina">Guardando...</span>
          </button>
          <button (click)="descargarRutinaPDF()" class="btn btn-info" [disabled]="cargandoRutina">
            üìÑ Descargar PDF
          </button>
          <button (click)="abrirModalEditar()" class="btn btn-warning" [disabled]="cargandoRutina">
            ‚úèÔ∏è Editar
          </button>
          <button (click)="generarRutina()" class="btn btn-secondary" [disabled]="cargandoRutina">
            üîÑ Regenerar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Guardar -->
  <app-guardar-rutina-modal
    [mostrar]="mostrarModalGuardar"
    [rutina]="rutinaGenerada"
    (guardarEvent)="guardarRutinaDesdeModal($event)"
    (cerrarEvent)="mostrarModalGuardar = false"
  ></app-guardar-rutina-modal>

  <!-- Modal de Editar -->
  <app-editar-rutina-modal
    [mostrar]="mostrarModalEditar"
    [rutina]="rutinaEditando || rutinaGenerada"
    (guardarEvent)="guardarCambiosEditar($event)"
    (cerrarEvent)="mostrarModalEditar = false"
  ></app-editar-rutina-modal>
</div>