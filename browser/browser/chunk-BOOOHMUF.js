import{I as h,J as b,L as i,P as j,U as g,g as m,l as c,mc as n,o as u,oc as v,v as p,x as o}from"./chunk-VJI5GMUY.js";var I=window.env?.apiUrl||"http://localhost:8000",a=`${I}/mensajes`,_=class l{http=g(v);mensajesNoLeidosSubject=new m(0);mensajesNoLeidos$=this.mensajesNoLeidosSubject.asObservable();pollingInterval=3e4;constructor(){this.iniciarPollingMensajes()}getUserId(){let e=localStorage.getItem("usuario");if(!e)return 0;let r=JSON.parse(e);return r.id||r.id_usuario||0}obtenerRol(){try{let e=localStorage.getItem("usuario");if(!e)return null;let r=JSON.parse(e);return r.rol||r.role||null}catch{return null}}mapearConversacion(e){return{otro_usuario:{id_usuario:e.otro_usuario.id_usuario,nombre:e.otro_usuario.nombre,apellido:e.otro_usuario.apellido||"",email:e.otro_usuario.email||"",foto_url:e.otro_usuario.foto_url||null,rol:e.otro_usuario.rol||"usuario"},ultimo_mensaje:{id_mensaje:e.ultimo_mensaje.id_mensaje,id_remitente:e.ultimo_mensaje.id_remitente,id_destinatario:e.ultimo_mensaje.id_destinatario,contenido:e.ultimo_mensaje.contenido,fecha_envio:e.ultimo_mensaje.fecha_envio,leido:e.ultimo_mensaje.leido,es_remitente:e.ultimo_mensaje.es_remitente},mensajes_no_leidos:e.mensajes_no_leidos||0}}iniciarPollingMensajes(){let e=this.getUserId();e&&p(this.pollingInterval).pipe(h(0),b(()=>this.contarMensajesNoLeidos(e))).subscribe({next:r=>{this.mensajesNoLeidosSubject.next(r.no_leidos)},error:r=>{console.error("\u274C Error en polling mensajes:",r)}})}enviarMensaje(e){let r=this.getUserId();if(!r)return c(()=>new Error("Usuario no autenticado"));let t=new n().set("user_id",r);return this.http.post(a,e,{params:t}).pipe(i(()=>console.log("\u{1F4E8} Mensaje enviado")),o(this.handleError))}obtenerMensaje(e){let r=this.getUserId(),t=new n().set("user_id",r);return this.http.get(`${a}/${e}`,{params:t}).pipe(o(this.handleError))}obtenerConversacion(e,r=50,t=0){let s=this.getUserId(),d=new n().set("user_id",s).set("limit",r).set("offset",t);return this.http.get(`${a}/conversacion/${e}`,{params:d}).pipe(i(M=>console.log("\u{1F4E8} Conversaci\xF3n cargada:",M.total)),o(this.handleError))}obtenerConversaciones(){return this.obtenerRol()?.toLowerCase()?.includes("entrenador")?this.obtenerConversacionesEntrenador():this.obtenerConversacionesCliente()}obtenerConversacionesCliente(){let e=this.getUserId(),r=new n().set("user_id",e);return this.http.get(`${a}/mis-conversaciones/lista`,{params:r}).pipe(u(t=>t.map(s=>this.mapearConversacion(s))),o(this.handleError))}obtenerConversacionesEntrenador(){let e=this.getUserId(),r=new n().set("user_id",e);return this.http.get(`${a}/mis-conversaciones-entrenador/lista`,{params:r}).pipe(u(t=>t.map(s=>this.mapearConversacion(s))),o(this.handleError))}marcarComoLeido(e){let r=this.getUserId(),t=new n().set("user_id",r);return this.http.post(`${a}/${e}/marcar-leido`,{},{params:t}).pipe(o(this.handleError))}marcarConversacionLeida(e){let r=this.getUserId(),t=new n().set("user_id",r);return this.http.post(`${a}/marcar-conversacion-leida/${e}`,{},{params:t}).pipe(i(()=>this.actualizarContadorMensajes()),o(this.handleError))}contarMensajesNoLeidos(e){let r=e||this.getUserId(),t=new n().set("user_id",r);return this.http.get(`${a}/no-leidos/contar`,{params:t}).pipe(o(this.handleError))}actualizarContadorMensajes(){let e=this.getUserId();this.contarMensajesNoLeidos(e).subscribe({next:r=>this.mensajesNoLeidosSubject.next(r.no_leidos)})}eliminarMensaje(e){let r=this.getUserId(),t=new n().set("user_id",r);return this.http.delete(`${a}/${e}`,{params:t}).pipe(o(this.handleError))}handleError(e){let r="Error desconocido";return e.error?.detail?r=e.error.detail:r=`Error ${e.status}: ${e.message}`,console.error("\u274C MensajesService:",r),c(()=>new Error(r))}obtenerIniciales(e){if(!e)return"?";let r=e.nombre||e.nombres||"",t=e.apellido||e.apellido_pat||e.apellidos||"";return((r?.charAt(0)||"")+(t?.charAt(0)||"")).toUpperCase()}obtenerNombreCompleto(e){if(!e)return"";let r=e.nombre||e.nombres||"",t=e.apellido_pat||e.apellidoPaterno||"",s=e.apellido_mat||e.apellidoMaterno||"";return`${r} ${t} ${s}`.trim()}formatearFechaMensaje(e){if(!e)return"";let r=new Date(e),t=new Date,s=r.getDate()===t.getDate()&&r.getMonth()===t.getMonth()&&r.getFullYear()===t.getFullYear(),d={hour:"numeric",minute:"numeric"};return s?`Hoy \xB7 ${r.toLocaleTimeString("es-MX",d)}`:r.toLocaleDateString("es-MX",{day:"2-digit",month:"short"})}formatearFechaCompleta(e){return e?new Date(e).toLocaleString("es-MX",{day:"2-digit",month:"long",year:"numeric",hour:"numeric",minute:"numeric"}):""}static \u0275fac=function(r){return new(r||l)};static \u0275prov=j({token:l,factory:l.\u0275fac,providedIn:"root"})};export{_ as a};
