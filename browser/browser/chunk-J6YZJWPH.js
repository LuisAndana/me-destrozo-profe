import{a as s}from"./chunk-V7WHDDYD.js";import{b as N,d as L,e as G,f as E,g as V,h as z,t as T,y as j}from"./chunk-T5YDL63U.js";import{e as B}from"./chunk-XCTHI3QZ.js";import{Ga as h,La as _,Xa as a,Ya as l,Z as m,Za as c,_ as u,db as v,eb as M,gc as R,ib as S,jb as x,kb as O,lc as P,oc as k,pb as p,sc as I,tb as b,ub as C,vb as w,wa as f}from"./chunk-VJI5GMUY.js";import{a as g,b as d}from"./chunk-FDERIQAA.js";var W=["googleSignInBtn"],H=class y{constructor(t,o){this.http=t;this.router=o}email="";password="";googleSignInBtn;lastGoogleCredential=null;normalizeRole(t){let o=(t??"").toLowerCase().trim();return{alumno:"alumno",cliente:"alumno",user:"alumno",empleado:"alumno",entrenador:"entrenador",coach:"entrenador",trainer:"entrenador"}[o]??"alumno"}goToHomeByRole(t){let e=this.normalizeRole(t)==="entrenador"?"/pagina-principal-entrenador":"/cliente";this.router.navigateByUrl(e,{replaceUrl:!0})}ngAfterViewInit(){let t=()=>{if(!s.googleClientId){console.error("googleClientId vac\xEDo en environment");return}google?.accounts.id.initialize({client_id:s.googleClientId,callback:o=>this.onGoogleCredential(o),ux_mode:"popup"}),google?.accounts.id.renderButton(this.googleSignInBtn.nativeElement,{type:"standard",theme:"outline",size:"large",text:"continue_with",shape:"pill",width:320})};window.google?t():window.onGoogleLibraryLoad=t}onGoogleCredential(t){let o=t?.credential;if(!o){alert("No se recibi\xF3 credencial de Google");return}this.lastGoogleCredential=o,this.http.post(`${s.apiBase}/auth/google_signin`,{credential:o}).subscribe({next:e=>{if(!e?.ok){alert(e?.mensaje||"No se pudo iniciar sesi\xF3n con Google.");return}let i=e.usuario?.rol??e.rol??"alumno",n=this.normalizeRole(i),r=e.usuario??{id:e.user_id,nombre:e.nombres||"",apellido:"",email:e.email||"",rol:n};e.token&&localStorage.setItem("token",e.token),localStorage.setItem("usuario",JSON.stringify(d(g({},r),{rol:n}))),this.goToHomeByRole(n)},error:e=>{console.error("[google_signin][login] error:",e);let i=e?.error?.detail||"";if(e?.status===0)return alert("No se pudo conectar al servidor (CORS/puerto).");if(e?.status===401)return alert(i||"Token de Google inv\xE1lido.");if(e?.status===409)return alert(i||"El email ya est\xE1 registrado.");if(e?.status===422){let n=prompt('Selecciona tu rol: escribe "alumno" o "entrenador"');return!n||!/^(alumno|entrenador)$/i.test(n)?alert('Rol inv\xE1lido. Intenta de nuevo con "alumno" o "entrenador".'):this.retryGoogleWithRole(n.toLowerCase())}alert(i||"No se pudo iniciar sesi\xF3n con Google.")}})}retryGoogleWithRole(t){this.lastGoogleCredential&&this.http.post(`${s.apiBase}/auth/google_signin`,{credential:this.lastGoogleCredential,rol:t}).subscribe({next:o=>{if(!o?.ok){alert(o?.mensaje||"No se pudo completar el registro con Google.");return}let e=o.usuario?.rol??o.rol??t,i=this.normalizeRole(e),n=o.usuario??{id:o.user_id,nombre:o.nombres||"",apellido:"",email:o.email||"",rol:i};o.token&&localStorage.setItem("token",o.token),localStorage.setItem("usuario",JSON.stringify(d(g({},n),{rol:i}))),this.goToHomeByRole(i)},error:o=>{console.error("[google_signin][retry] error:",o);let e=o?.error?.detail||"";if(o?.status===409)return alert(e||"El email ya est\xE1 registrado.");alert(e||"No se pudo completar el registro con Google.")}})}login(){let t=(this.email||"").trim().toLowerCase(),o=(this.password||"").trim();if(!t||!o){alert("Ingresa email y contrase\xF1a");return}let e=`${s.apiBase}/auth/login`,i=new P({"Content-Type":"application/json"});this.http.post(e,{email:t,password:o},{headers:i,withCredentials:!1}).subscribe({next:n=>{if(n?.ok&&n.token&&n.usuario){localStorage.setItem("token",n.token);let r=this.normalizeRole(n.usuario.rol),F=d(g({},n.usuario),{rol:r});localStorage.setItem("usuario",JSON.stringify(F)),this.goToHomeByRole(r)}else alert(n?.mensaje||"Error en login")},error:n=>{console.error("\u274C Error en login:",n);let r=n?.error?.detail||n?.message||"";if(n?.status===0)return alert("No se pudo conectar al servidor (puerto/CORS).");if(n?.status===400&&/google/i.test(r))return alert('Tu cuenta est\xE1 vinculada a Google. Usa el bot\xF3n "Continuar con Google".');if(n?.status===401)return alert("Contrase\xF1a incorrecta.");if(n?.status===404)return alert("Usuario no encontrado.");if(n?.status===422)return alert("Payload inv\xE1lido (email/password).");alert(r||"Error en login")}})}continuar(){let t=localStorage.getItem("usuario"),o=t?JSON.parse(t):null;if(!o){this.router.navigateByUrl("/login",{replaceUrl:!0});return}let e=this.normalizeRole(o.rol);this.goToHomeByRole(e)}goToRegister(){this.router.navigate(["/registro"])}static \u0275fac=function(o){return new(o||y)(h(k),h(B))};static \u0275cmp=_({type:y,selectors:[["app-login"]],viewQuery:function(o,e){if(o&1&&S(W,5),o&2){let i;x(i=O())&&(e.googleSignInBtn=i.first)}},decls:18,vars:2,consts:[["googleSignInBtn",""],[1,"login-container"],[1,"login-banner"],[1,"banner-overlay"],["src","/assets/gym-banner_page.jpg","alt","Banner",1,"banner-img"],[1,"login-form-section"],[1,"login-title"],[1,"login-form",3,"ngSubmit"],["type","email","placeholder","E-Mail","name","email","required","",3,"ngModelChange","ngModel"],["type","password","placeholder","Contrase\xF1a","name","password","required","",3,"ngModelChange","ngModel"],[1,"divider-form"],[1,"login-google-label"],[1,"google-wrap"],["id","googleSignInBtn"],["type","submit",1,"continue-btn"]],template:function(o,e){if(o&1){let i=v();a(0,"div",1)(1,"div",2),c(2,"div",3)(3,"img",4),l(),a(4,"div",5)(5,"h2",6),p(6,"Login de usuario"),l(),a(7,"form",7),M("ngSubmit",function(){return m(i),u(e.login())}),a(8,"input",8),w("ngModelChange",function(r){return m(i),C(e.email,r)||(e.email=r),u(r)}),l(),a(9,"input",9),w("ngModelChange",function(r){return m(i),C(e.password,r)||(e.password=r),u(r)}),l(),c(10,"div",10),a(11,"span",11),p(12,"Inicia sesi\xF3n con"),l(),a(13,"div",12),c(14,"div",13,0),l(),a(16,"button",14),p(17,"Continuar"),l()()()()}o&2&&(f(8),b("ngModel",e.email),f(),b("ngModel",e.password))},dependencies:[R,j,z,N,L,G,T,V,E,I],styles:[".login-container[_ngcontent-%COMP%]{display:flex;height:100vh;width:100%;background:#181818;font-family:Arial,sans-serif;overflow-x:hidden}.login-banner[_ngcontent-%COMP%]{flex:1;position:relative;display:flex;align-items:stretch;justify-content:stretch;overflow:hidden}.banner-img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;display:block}.banner-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#0000008c;z-index:1}.login-form-section[_ngcontent-%COMP%]{flex:1;background:#232323;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2.5rem 2rem}.login-title[_ngcontent-%COMP%]{color:#fff;font-size:2rem;font-weight:700;margin-bottom:1.25rem;text-align:center}.login-form[_ngcontent-%COMP%]{width:100%;max-width:400px;display:flex;flex-direction:column;gap:1rem}.login-form[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{background:#181818;border:1px solid #444;color:#fff;padding:.8rem 1rem;border-radius:8px;font-size:1rem;outline:none}.login-form[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{border-color:#4d90fe;box-shadow:0 0 0 3px #4d90fe2e}.divider-form[_ngcontent-%COMP%]{height:1px;background:#444;margin:.6rem 0 .9rem}.login-google-label[_ngcontent-%COMP%]{color:#aaa;text-align:center;font-size:.95rem;display:block;margin-bottom:.45rem}.google-wrap[_ngcontent-%COMP%]{display:flex;justify-content:center;width:100%}#googleSignInBtn[_ngcontent-%COMP%]{width:100%;max-width:340px}.google-btn[_ngcontent-%COMP%], .google-btn[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{display:none!important}.continue-btn[_ngcontent-%COMP%]{background:#4d90fe;color:#fff;border:none;border-radius:10px;padding:.9rem 1rem;font-size:1rem;font-weight:800;cursor:pointer;margin-top:.55rem;transition:background .2s,transform .06s;box-shadow:0 10px 24px #4d90fe40}.continue-btn[_ngcontent-%COMP%]:hover{background:#357ae8}.continue-btn[_ngcontent-%COMP%]:active{transform:translateY(1px)}@media (max-width: 900px){.login-container[_ngcontent-%COMP%]{flex-direction:column}.login-banner[_ngcontent-%COMP%], .login-form-section[_ngcontent-%COMP%]{min-height:50vh;width:100%}.login-form-section[_ngcontent-%COMP%]{padding:2rem 1rem}}"]})};export{H as Login};
