import{a as i}from"./chunk-V7WHDDYD.js";import{J as u,L as m,P as h,U as d,g as c,k as p,o as g,oc as U}from"./chunk-VJI5GMUY.js";import{a as l}from"./chunk-FDERIQAA.js";var n="gym_token",f="token",y="gym_user",_=["firebaseUser","googleUser","g_token","authUser","oauth_user"],b=class a{http=d(U);_user$=new c(this.restoreUser());user$=this._user$.asObservable();get user(){return this._user$.value}constructor(){["token","g_token","authUser","firebaseUser","googleUser","oauth_user"].forEach(r=>localStorage.removeItem(r)),localStorage.removeItem("token"),localStorage.getItem(n)||this.setUser(null)}get isAuthenticated(){return!!this.getToken()}wipeExternalAuthArtifacts(){_.forEach(e=>localStorage.removeItem(e))}normalizeUser(e){if(!e)return null;let t=Number(e.id_usuario??e.id??e.uid??NaN),r=e.nombre??e.displayName??"",s=e.apellido??e.apellidos??"",o=e.email??e.correo??"",v=this.mapRolApiToUi(e.rol);return!Number.isFinite(t)||!o?null:{id_usuario:t,nombre:r,apellido:s,email:o,rol:v}}restoreUser(){try{let e=localStorage.getItem(y);return this.normalizeUser(e?JSON.parse(e):null)}catch{return null}}mapRolApiToUi(e){let t=(e||"").toLowerCase();return t==="cliente"||t==="alumno"?"alumno":t==="entrenador"?"entrenador":"alumno"}setUser(e){e?localStorage.setItem("gym_user",JSON.stringify(e)):localStorage.removeItem("gym_user"),this._user$.next(e)}saveToken(e){let t=(e||"").trim();t&&localStorage.setItem(n,t)}getToken(){let e=localStorage.getItem(n)||localStorage.getItem(f)||"";return e.trim()?e.trim():null}login(e){let t=i.apiBase+i.endpoints.login;return this.http.post(t,e).pipe(m(r=>{this.saveToken(r.token),this.wipeExternalAuthArtifacts()}),u(()=>this.fetchMe()))}register(e){let t=i.apiBase+i.endpoints.register,r={nombre:e.nombre,apellido:e.apellido,email:e.email,password:e.password};return this.http.post(t,r).pipe(u(()=>this.login({email:e.email,password:e.password})))}fetchMe(){let e=i.apiBase+i.endpoints.me,t=this.getToken();if(!t)return console.warn("[AuthService] No hay token, cerrando sesi\xF3n."),this.logout(),p(null);let r={Authorization:`Bearer ${t}`};return this.http.get(e,{headers:r}).pipe(g(s=>{let o=s?.usuario??s;return this.normalizeUser({id:o.id??o.id_usuario,nombre:o.nombre,apellido:o.apellido,email:o.email,rol:o.rol})}),m(s=>{s&&this.setUser(s)}))}patchLocalUser(e){let t=this.user;if(!t)return;let r=l(l({},t),e);localStorage.setItem("gym_user",JSON.stringify(r)),this._user$.next(r)}logout(){localStorage.removeItem(n),localStorage.removeItem(f),this.setUser(null),this.wipeExternalAuthArtifacts()}static \u0275fac=function(t){return new(t||a)};static \u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})};export{b as a};
